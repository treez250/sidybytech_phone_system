# Kamailio SIP Proxy Configuration
# Basic configuration for carrier operations

#!KAMAILIO

####### Global Parameters #########

debug=2
log_stderror=no
memdbg=5
memlog=5
log_facility=LOG_LOCAL0
fork=yes
children=4

listen=udp:0.0.0.0:5080
listen=tcp:0.0.0.0:5080

####### Modules Section ########

loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"

####### Routing Logic ########

request_route {
    # Per request initial checks
    route(REQINIT);
    
    # Handle requests within SIP dialogs
    route(WITHINDLG);
    
    # Handle registrations
    route(REGISTRAR);
    
    # Forward to Asterisk
    route(RELAY);
}

route[REQINIT] {
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }

    if(!sanity_check("1511", "7")) {
        xlog("Malformed SIP message from $si:$sp\n");
        exit;
    }
}

route[WITHINDLG] {
    if (has_totag()) {
        if (loose_route()) {
            route(RELAY);
        } else {
            if (is_method("ACK")) {
                if (t_check_trans()) {
                    t_relay();
                    exit;
                } else {
                    exit;
                }
            }
            sl_send_reply("404","Not here");
        }
        exit;
    }
}

route[REGISTRAR] {
    if (is_method("REGISTER")) {
        sl_send_reply("200", "OK");
        exit;
    }
}

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}
