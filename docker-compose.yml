version: '3.8'

services:
  # MariaDB Database
  mariadb:
    image: mariadb:10.11
    container_name: pbx-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: asterisk
      MYSQL_USER: asteriskuser
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb-data:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf
    networks:
      - pbx-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: pbx-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - pbx-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # FreePBX/Asterisk
  freepbx:
    image: tiredofit/freepbx:17
    container_name: pbx-freepbx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "5061:5061/tcp"
      - "10000-10200:10000-10200/udp"
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_NAME=asterisk
      - DB_USER=asteriskuser
      - DB_PASS=${MYSQL_PASSWORD}
      - ENABLE_FAIL2BAN=TRUE
      - ENABLE_CRON=TRUE
      - RTP_START=10000
      - RTP_FINISH=10200
    volumes:
      - freepbx-data:/data
      - freepbx-logs:/var/log
      - ./config/asterisk:/assets/custom
      - ./scripts:/usr/local/bin/custom
    networks:
      - pbx-network
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    cap_add:
      - NET_ADMIN

  # Kamailio and RTPEngine disabled for initial setup
  # Uncomment these after basic system is working
  
  # kamailio:
  #   build: ./docker/kamailio
  #   container_name: pbx-kamailio
  #   restart: unless-stopped
  #   ports:
  #     - "5080:5080/udp"
  #     - "5080:5080/tcp"
  #   environment:
  #     - ASTERISK_HOST=freepbx
  #     - DB_HOST=mariadb
  #   volumes:
  #     - ./config/kamailio:/etc/kamailio
  #   networks:
  #     - pbx-network
  #   depends_on:
  #     - mariadb
  #     - freepbx

  # rtpengine:
  #   build: ./docker/rtpengine
  #   container_name: pbx-rtpengine
  #   restart: unless-stopped
  #   network_mode: host
  #   volumes:
  #     - ./config/rtpengine:/etc/rtpengine
  #   cap_add:
  #     - NET_ADMIN

  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: pbx-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - pbx-network

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: pbx-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana:/etc/grafana/provisioning
    networks:
      - pbx-network
    depends_on:
      - prometheus

volumes:
  mariadb-data:
  redis-data:
  freepbx-data:
  freepbx-logs:
  prometheus-data:
  grafana-data:

networks:
  pbx-network:
    driver: bridge
