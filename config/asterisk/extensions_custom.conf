; Custom Dialplan for Carrier Operations
; This file contains carrier-level routing logic

[carrier-inbound]
; Incoming calls from customers
exten => _X.,1,NoOp(Incoming call from ${CALLERID(num)} to ${EXTEN})
 same => n,Set(CDR(accountcode)=${CHANNEL(endpoint)})
 same => n,Set(CHANNEL(language)=en)
 same => n,GotoIf($["${DB_EXISTS(blacklist/${CALLERID(num)})}" = "1"]?blocked)
 same => n,Set(CUSTOMER_ID=${ODBC_CUSTOMER_LOOKUP(${CHANNEL(endpoint)})})
 same => n,GotoIf($["${CUSTOMER_ID}" = ""]?unauthorized)
 same => n,Set(CDR(userfield)=${CUSTOMER_ID})
 same => n,Gosub(fraud-check,s,1(${CALLERID(num)},${CUSTOMER_ID}))
 same => n,GotoIf($["${FRAUDCHECK}" = "FAIL"]?fraud)
 same => n,Gosub(balance-check,s,1(${CUSTOMER_ID}))
 same => n,GotoIf($["${BALANCE_OK}" != "1"]?insufficient)
 same => n,Gosub(lcr-routing,s,1(${EXTEN},${CUSTOMER_ID}))
 same => n,Dial(${ROUTE_STRING},60,TtKkg)
 same => n,Goto(call-end,${DIALSTATUS},1)

exten => _X.,n(blocked),NoOp(Blocked caller)
 same => n,Playback(ss-noservice)
 same => n,Hangup()

exten => _X.,n(unauthorized),NoOp(Unauthorized endpoint)
 same => n,Playback(ss-noservice)
 same => n,Hangup()

exten => _X.,n(fraud),NoOp(Fraud detected)
 same => n,System(/usr/local/bin/fraud-alert.sh ${CALLERID(num)} ${CUSTOMER_ID})
 same => n,Hangup()

exten => _X.,n(insufficient),NoOp(Insufficient balance)
 same => n,Playback(insufficient-funds)
 same => n,Hangup()

[carrier-outbound]
; Outgoing calls to upstream carriers
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CDR(accountcode)=CARRIER_OUT)
 same => n,Dial(${ARG1},60,TtKkg)
 same => n,Hangup()

[lcr-routing]
; Least Cost Routing subroutine
exten => s,1,NoOp(LCR for ${ARG1} customer ${ARG2})
 same => n,Set(ROUTE_STRING=${ODBC_LCR_ROUTE(${ARG1},${ARG2})})
 same => n,GotoIf($["${ROUTE_STRING}" = ""]?no-route)
 same => n,Return()
 same => n(no-route),Set(ROUTE_STRING=)
 same => n,Return()

[fraud-check]
; Fraud detection subroutine
exten => s,1,NoOp(Fraud check for ${ARG1})
 same => n,Set(CALL_COUNT=${ODBC_CALL_COUNT(${ARG1},300)})
 same => n,GotoIf($[${CALL_COUNT} > 50]?fraud)
 same => n,Set(FRAUDCHECK=PASS)
 same => n,Return()
 same => n(fraud),Set(FRAUDCHECK=FAIL)
 same => n,Return()

[balance-check]
; Balance verification subroutine
exten => s,1,NoOp(Balance check for customer ${ARG1})
 same => n,Set(BALANCE=${ODBC_GET_BALANCE(${ARG1})})
 same => n,GotoIf($[${BALANCE} > 0]?ok)
 same => n,Set(BALANCE_OK=0)
 same => n,Return()
 same => n(ok),Set(BALANCE_OK=1)
 same => n,Return()

[call-end]
; Call completion handling
exten => ANSWER,1,NoOp(Call answered)
 same => n,Hangup()

exten => BUSY,1,NoOp(Destination busy)
 same => n,Hangup()

exten => NOANSWER,1,NoOp(No answer)
 same => n,Hangup()

exten => CONGESTION,1,NoOp(Congestion)
 same => n,Hangup()

exten => CHANUNAVAIL,1,NoOp(Channel unavailable)
 same => n,Hangup()

exten => _X,1,NoOp(Other status: ${EXTEN})
 same => n,Hangup()

[emergency]
; Emergency services routing
exten => 911,1,NoOp(Emergency call from ${CALLERID(num)})
 same => n,Set(CDR(accountcode)=EMERGENCY)
 same => n,Dial(SIP/emergency-trunk/911,30,TtKk)
 same => n,Hangup()

[internal]
; Internal extensions for management
exten => 9999,1,Answer()
 same => n,Playback(welcome)
 same => n,Hangup()
